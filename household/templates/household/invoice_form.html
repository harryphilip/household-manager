{% extends 'household/base.html' %}

{% block title %}{% if object %}Edit Invoice{% else %}Create Invoice{% endif %} - Household Manager{% endblock %}

{% block content %}
<h1>{% if object %}Edit Invoice{% else %}Create New Invoice{% endif %}</h1>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% if form.errors %}
    <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <strong>Please correct the errors below:</strong>
        <ul style="margin-top: 10px; margin-bottom: 0;">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>{{ field|title }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    <div class="form-group">
        <label for="id_house">House *</label>
        {{ form.house }}
        {% if form.house.errors %}
            <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px;">{{ form.house.errors }}</div>
        {% endif %}
    </div>
    
    <!-- PDF Upload and Processing Section -->
    <div class="form-group" style="margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 5px; border: 2px dashed #dee2e6;">
        <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 1.2em;">ðŸ“„ Upload Invoice PDF (Optional)</h3>
        <p style="color: #666; margin-bottom: 15px;">Upload an invoice PDF to automatically extract and fill in invoice information, line items, and vendor details.</p>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="file" id="invoice-pdf-upload" accept=".pdf" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
            <button type="button" id="process-pdf-btn" class="btn btn-primary" style="padding: 8px 20px; white-space: nowrap;" disabled>Process PDF</button>
        </div>
        <div id="pdf-processing-status" style="margin-top: 10px; display: none;"></div>
    </div>
    <div class="form-group">
        <label for="id_invoice_number">Invoice Number *</label>
        {{ form.invoice_number }}
        {% if form.invoice_number.errors %}
            <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px;">{{ form.invoice_number.errors }}</div>
        {% endif %}
    </div>
    <div class="form-group">
        <label for="id_vendor">Vendor</label>
        {{ form.vendor }}
        {% if form.vendor.errors %}
            <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px;">{{ form.vendor.errors }}</div>
        {% endif %}
    </div>
    <div class="form-group">
        <label for="id_invoice_date">Invoice Date *</label>
        {{ form.invoice_date }}
        {% if form.invoice_date.errors %}
            <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px;">{{ form.invoice_date.errors }}</div>
        {% endif %}
    </div>
    <div class="form-group">
        <label for="id_due_date">Due Date</label>
        {{ form.due_date }}
        {% if form.due_date.errors %}
            <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px;">{{ form.due_date.errors }}</div>
        {% endif %}
    </div>
    
    <h2 style="margin-top: 30px; margin-bottom: 20px;">Line Items</h2>
    <p style="color: #666; margin-bottom: 15px;">Add line items to break down the invoice. Each line item can be associated with specific rooms and/or appliances.</p>
    {% if line_items.non_form_errors %}
    <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <strong>Line Items Errors:</strong>
        <ul style="margin-top: 10px; margin-bottom: 0;">
            {% for error in line_items.non_form_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    <div id="line-items-container">
        {{ line_items.management_form }}
        <table id="line-items-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">
                    <th style="padding: 8px;">Description</th>
                    <th style="padding: 8px; width: 100px;">Quantity</th>
                    <th style="padding: 8px; width: 120px;">Unit Price</th>
                    <th style="padding: 8px; width: 120px;">Line Total</th>
                    <th style="padding: 8px;">Rooms</th>
                    <th style="padding: 8px;">Appliances</th>
                    <th style="padding: 8px; width: 60px;">Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for form in line_items.forms %}
                <tr class="line-item-row">
                    <td style="padding: 8px;">{{ form.description }}{{ form.id }}</td>
                    <td style="padding: 8px;">{{ form.quantity }}</td>
                    <td style="padding: 8px;">{{ form.unit_price }}</td>
                    <td style="padding: 8px;">{{ form.line_total }}</td>
                    <td style="padding: 8px;">{{ form.rooms }}</td>
                    <td style="padding: 8px;">{{ form.appliances }}</td>
                    <td style="padding: 8px; text-align: center;">{{ form.DELETE }}</td>
                </tr>
                {% if form.errors %}
                <tr>
                    <td colspan="7" style="color: #dc3545; padding: 8px; background-color: #f8d7da;">
                        <strong>Errors:</strong>
                        <ul style="margin: 5px 0 0 20px; padding: 0;">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ field|title }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        <button type="button" id="add-line-item" class="btn btn-secondary" style="margin-bottom: 20px;">Add Line Item</button>
    </div>
    
    <div class="form-group">
        <label for="id_tax_amount">Tax Amount</label>
        {{ form.tax_amount }}
        <small style="display: block; color: #666; margin-top: 5px;">Subtotal will be calculated from line items. Enter tax amount here.</small>
    </div>
    <div class="form-group">
        <label for="id_total_amount">Total Amount</label>
        {{ form.total_amount }}
        <small style="display: block; color: #666; margin-top: 5px;">Will be calculated automatically (Subtotal + Tax)</small>
    </div>
    <div class="form-group">
        <label for="id_category">Category *</label>
        {{ form.category }}
    </div>
    <div class="form-group">
        <label for="id_description">Description</label>
        {{ form.description }}
    </div>
    <div class="form-group">
        <label for="id_paid">Paid</label>
        {{ form.paid }}
    </div>
    <div class="form-group">
        <label for="id_paid_date">Paid Date</label>
        {{ form.paid_date }}
    </div>
    <div class="form-group">
        <label for="id_payment_method">Payment Method</label>
        {{ form.payment_method }}
    </div>
    <div class="form-group">
        <label for="id_invoice_file">Invoice File</label>
        {{ form.invoice_file }}
    </div>
    <div class="form-group">
        <label for="id_related_appliance">Related Appliance</label>
        {{ form.related_appliance }}
    </div>
    <div class="form-group">
        <label for="id_notes">Notes</label>
        {{ form.notes }}
    </div>
    <div class="form-actions">
        <button type="submit" class="btn">{% if object %}Update{% else %}Create{% endif %} Invoice</button>
        <a href="{% if object %}{% url 'invoice_detail' object.pk %}{% else %}{% url 'invoice_list' %}{% endif %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calculate line totals
    function calculateLineTotal(row) {
        const quantity = parseFloat(row.querySelector('input[name*="quantity"]')?.value || 0);
        const unitPrice = parseFloat(row.querySelector('input[name*="unit_price"]')?.value || 0);
        const lineTotalInput = row.querySelector('input[name*="line_total"]');
        if (lineTotalInput) {
            lineTotalInput.value = (quantity * unitPrice).toFixed(2);
        }
    }
    
    // Add event listeners to quantity and unit_price inputs
    document.querySelectorAll('.line-item-row').forEach(row => {
        const quantityInput = row.querySelector('input[name*="quantity"]');
        const unitPriceInput = row.querySelector('input[name*="unit_price"]');
        
        if (quantityInput) {
            quantityInput.addEventListener('input', () => calculateLineTotal(row));
        }
        if (unitPriceInput) {
            unitPriceInput.addEventListener('input', () => calculateLineTotal(row));
        }
    });
    
    // Add new line item
    let formCount = {{ line_items.forms|length }};
    document.getElementById('add-line-item').addEventListener('click', function() {
        const formset = document.getElementById('line-items-table').querySelector('tbody');
        const totalFormsInput = document.querySelector('input[name="line_items-TOTAL_FORMS"]');
        const newRow = formset.querySelector('.line-item-row').cloneNode(true);
        
        // Update form indices
        newRow.querySelectorAll('input, select').forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/-0-/, `-${formCount}-`);
                input.id = input.id.replace(/-0-/, `-${formCount}-`);
                input.value = '';
                if (input.type === 'checkbox') {
                    input.checked = false;
                }
            }
        });
        
        // Clear values
        newRow.querySelector('input[name*="quantity"]').value = '1';
        newRow.querySelector('input[name*="unit_price"]').value = '';
        newRow.querySelector('input[name*="line_total"]').value = '';
        newRow.querySelector('input[name*="description"]').value = '';
        
        // Add event listeners
        const quantityInput = newRow.querySelector('input[name*="quantity"]');
        const unitPriceInput = newRow.querySelector('input[name*="unit_price"]');
        quantityInput.addEventListener('input', () => calculateLineTotal(newRow));
        unitPriceInput.addEventListener('input', () => calculateLineTotal(newRow));
        
        formset.appendChild(newRow);
        formCount++;
        totalFormsInput.value = formCount;
    });
    
    // PDF Processing
    const pdfUploadInput = document.getElementById('invoice-pdf-upload');
    const processPdfBtn = document.getElementById('process-pdf-btn');
    const pdfStatusDiv = document.getElementById('pdf-processing-status');
    
    pdfUploadInput.addEventListener('change', function() {
        processPdfBtn.disabled = !this.files || this.files.length === 0;
    });
    
    processPdfBtn.addEventListener('click', function() {
        const file = pdfUploadInput.files[0];
        if (!file) {
            alert('Please select a PDF file first.');
            return;
        }
        
        // Show processing status
        pdfStatusDiv.style.display = 'block';
        pdfStatusDiv.innerHTML = '<div style="color: #0c5460; background-color: #d1ecf1; padding: 10px; border-radius: 4px;">Processing PDF... Please wait.</div>';
        processPdfBtn.disabled = true;
        
        // Create FormData
        const formData = new FormData();
        formData.append('pdf_file', file);
        
        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Send request
        fetch('{% url "process_invoice_pdf" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                pdfStatusDiv.innerHTML = `<div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px;">Error: ${data.error}</div>`;
                processPdfBtn.disabled = false;
                return;
            }
            
            if (data.success) {
                // Fill in invoice fields
                const invoiceData = data.invoice_data;
                
                // Fill basic invoice fields
                if (invoiceData.invoice_number) {
                    document.getElementById('id_invoice_number').value = invoiceData.invoice_number;
                }
                if (invoiceData.invoice_date) {
                    document.getElementById('id_invoice_date').value = invoiceData.invoice_date;
                }
                if (invoiceData.due_date) {
                    document.getElementById('id_due_date').value = invoiceData.due_date;
                }
                if (invoiceData.tax_amount) {
                    document.getElementById('id_tax_amount').value = invoiceData.tax_amount;
                }
                if (invoiceData.total_amount) {
                    document.getElementById('id_total_amount').value = invoiceData.total_amount;
                }
                if (invoiceData.notes) {
                    document.getElementById('id_notes').value = invoiceData.notes;
                }
                
                // Fill vendor
                if (data.vendor_id) {
                    document.getElementById('id_vendor').value = data.vendor_id;
                } else if (data.vendor_data) {
                    // Show message that vendor needs to be created
                    pdfStatusDiv.innerHTML += `<div style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px;">Note: Vendor "${data.vendor_data.name}" not found. Please create the vendor first or select an existing one.</div>`;
                }
                
                // Fill line items
                if (invoiceData.line_items && invoiceData.line_items.length > 0) {
                    const tbody = document.getElementById('line-items-table').querySelector('tbody');
                    const totalFormsInput = document.querySelector('input[name="line_items-TOTAL_FORMS"]');
                    let currentFormCount = parseInt(totalFormsInput.value) || 0;
                    
                    // Clear existing empty rows
                    const existingRows = tbody.querySelectorAll('.line-item-row');
                    existingRows.forEach(row => {
                        const descInput = row.querySelector('input[name*="description"]');
                        if (descInput && !descInput.value) {
                            row.remove();
                            currentFormCount--;
                        }
                    });
                    
                    // Add line items
                    invoiceData.line_items.forEach((item, index) => {
                        let row;
                        if (index === 0 && currentFormCount === 0) {
                            // Use first existing row
                            row = tbody.querySelector('.line-item-row');
                            if (!row) {
                                // Create new row if none exists
                                const firstRow = tbody.querySelector('tr');
                                if (firstRow) {
                                    row = firstRow.cloneNode(true);
                                    tbody.appendChild(row);
                                }
                            }
                        } else {
                            // Clone first row
                            const firstRow = tbody.querySelector('.line-item-row');
                            if (firstRow) {
                                row = firstRow.cloneNode(true);
                                tbody.appendChild(row);
                                
                                // Update form indices
                                row.querySelectorAll('input, select').forEach(input => {
                                    if (input.name) {
                                        input.name = input.name.replace(/-\d+-/, `-${currentFormCount}-`);
                                        input.id = input.id.replace(/-\d+-/, `-${currentFormCount}-`);
                                    }
                                });
                            } else {
                                continue;
                            }
                        }
                        
                        if (row) {
                            // Fill in line item data
                            const descInput = row.querySelector('input[name*="description"]');
                            const qtyInput = row.querySelector('input[name*="quantity"]');
                            const priceInput = row.querySelector('input[name*="unit_price"]');
                            const totalInput = row.querySelector('input[name*="line_total"]');
                            
                            if (descInput) descInput.value = item.description || '';
                            if (qtyInput) qtyInput.value = item.quantity || 1;
                            if (priceInput) priceInput.value = item.unit_price || 0;
                            if (totalInput) totalInput.value = item.line_total || (item.quantity * item.unit_price) || 0;
                            
                            currentFormCount++;
                        }
                    });
                    
                    totalFormsInput.value = currentFormCount;
                }
                
                // Show success message
                pdfStatusDiv.innerHTML = `<div style="color: #155724; background-color: #d4edda; padding: 10px; border-radius: 4px;">âœ“ PDF processed successfully! Invoice fields have been filled in. Please review and adjust as needed.</div>`;
                processPdfBtn.disabled = false;
            }
        })
        .catch(error => {
            pdfStatusDiv.innerHTML = `<div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px;">Error: ${error.message}</div>`;
            processPdfBtn.disabled = false;
        });
    });
});
</script>
{% endblock %}



